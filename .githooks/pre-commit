#!/usr/bin/env bash
set -euo pipefail

echo "WPMoo Coding Standards pre-commit: validate, PHPCBF, PHPCS"

# Allow hard skip via environment variable
if [ "${WPMOO_SKIP_HOOKS:-0}" = "1" ]; then
  echo "(hooks disabled via WPMOO_SKIP_HOOKS=1)"
  exit 0
fi

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | tr '\n' ' ')
PHP_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.php$' || true)

if [ -z "${STAGED_FILES}" ]; then
  echo "(no staged changes; skipping checks)"
  exit 0
fi

if command -v composer >/dev/null 2>&1 && [ -f composer.json ]; then
  # Allow warnings (e.g., version field) in this repo; fail only on invalid schema
  composer validate --no-check-lock --ansi || exit 1
fi

if [ -n "${PHP_FILES}" ]; then
  echo "→ Linting PHP files"
  while IFS= read -r file; do
    [ -f "$file" ] || continue
    php -l "$file" >/dev/null || { echo "PHP syntax error in $file"; exit 1; }
  done <<< "${PHP_FILES}"
fi

if [ -n "${PHP_FILES}" ]; then
  if [ -x vendor/bin/phpcbf ]; then
    echo "→ PHPCBF (auto-fix staged files)"
    vendor/bin/phpcbf ${PHP_FILES} || true
    git add ${PHP_FILES}
  fi
  if [ -x vendor/bin/phpcs ]; then
    echo "→ Running PHPCS on staged files (errors only)"
    vendor/bin/phpcs -n ${PHP_FILES} || exit 1
  fi
fi

echo "✔ Pre-commit checks passed"
exit 0
